<script src="../dist/deeplearn-caffe-models.js"></script>

<img id="img"></img>
<div id="result"></div>

<script>
  const img = document.getElementById('img');
  img.onload = async () => {
    const resultElement = document.getElementById('result');
    const dl = deeplearnCaffeModels.dl;
    const CAFFE_MODEL = deeplearnCaffeModels.NiN;

    resultElement.innerText = 'Loading model...';

    if (dl == null) {
      await new Promise(resolve => setTimeout(resolve, 1000));
    }

    // Use WebGL
    // const math = new dl.NDArrayMath('webgl', false);
    // dl.ENV.setMath(math);

    // Use CPU
    const math = new dl.NDArrayMath('cpu', false);
    dl.ENV.setMath(math);

    // Create and load model
    const model = new CAFFE_MODEL();
    await model.load();

    // Override imagenet training mean
    // model.setPreprocessOffset(arrToNDArray(dl, [122.0, 116.0, 104.0])); // color mode RGB
    // model.setPreprocessOffset(arrToNDArray(dl, [104.0, 116.0, 122.0])); // color mode BGR

    // We need to clean the nodes
    // as they contain names like conv4-1024
    // whereas the edge is called conv4
    model.setNodes(model.nodes.map(cleanNode));

    resultElement.innerText = 'Predicting...';

    const pixels = dl.Array3D.fromPixels(img);

    const result = await model.predict(pixels);

    resultElement.innerText = '';

    const k = 5;
    const topK = await deeplearnCaffeModels.util.getTopK(result, k);

    for (let i = 0; i < k; i++) {
      const idx = topK.indices[i];
      resultElement.innerText += `${topK.values[i].toFixed(5)}: ${CAFFE_MODEL.labels[idx]}\n`;
    };
  };
  img.src = 'img/cat.jpg';

  function cleanNode(node) {
    const n = node.name;
    node.name = n.indexOf("-" !== -1) ? n.split("-")[0] : n;
    return node;
  }

  function arrToNDArray(dl, arr) {
    return dl.NDArray.make([arr.length], {values: new Float32Array(arr)}, "float32");
  }
</script>
